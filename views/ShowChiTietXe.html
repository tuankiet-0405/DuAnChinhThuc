<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết xe - TKĐK</title>
    <link rel="stylesheet" href="/public/css/styles.css">
    <script src="/public/js/code.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Giữ lại các styles hiện có -->
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --background: #f8fafc;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* Container */
        .car-detail-container {
            max-width: 1200px;
            margin: 100px auto 2rem;
            padding: 0 2rem;
        }

        /* Phần hình ảnh */
        .car-images-section {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }

        .main-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 12px;
            transition: var(--transition);
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .thumbnail:hover,
        .thumbnail.active {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Grid cho content và form */
        .content-form-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 2rem;
            align-items: start;
        }

        /* Phần content bên trái */
        .car-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
        }

        .car-header {
            margin-bottom: 2rem;
        }

        .car-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .car-price {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .car-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-available {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        /* Thông tin chủ xe */
        .owner-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .owner-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
        }

        .owner-details h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .owner-details p {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Chi tiết xe */
        .car-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--background);
            border-radius: 12px;
            transition: var(--transition);
        }

        .detail-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 10px;
            color: var(--primary-color);
        }

        /* Mô tả xe */
        .car-description {
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .car-description h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Tính năng xe */
        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--background);
            border-radius: 10px;
            transition: var(--transition);
        }

        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .feature-item i {
            color: var(--success-color);
        }

        /* Form đặt xe */
        .rental-form-section {
            position: sticky;
            top: 2rem;
        }

        .rental-form {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Tính giá */
        .price-calculator {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: var(--text-light);
        }

        .price-total {
            display: flex;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 2px solid var(--border-color);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Nút đặt xe */
        .btn-rent {
            width: 100%;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn-rent:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Popup styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            display: none;
        }

        .location-popup,
        .promo-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            width: 500px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Map container */
        .location-map {
            width: 100%;
            height: 300px;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        /* Delivery options */
        .delivery-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .delivery-option {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .delivery-option:hover {
            border-color: var(--primary-color);
            background: var(--background);
        }

        .delivery-option.active {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }

        /* Footer Styles */
        .footer {
            background: #1a1a1a;
            color: #fff;
            padding: 4rem 0 2rem;
            margin-top: 4rem;
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .footer-section h3 {
            color: #fff;
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 0.75rem;
        }

        .footer-links a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.3s ease;
            font-size: 0.95rem;
        }

        .footer-links a:hover {
            color: var(--primary-color);
        }

        .footer-contact p {
            color: #9ca3af;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .social-links a {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .social-links a:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .footer-bottom {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        @media (max-width: 1024px) {
            .footer-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .footer-container {
                grid-template-columns: 1fr;
            }

            .footer {
                padding: 3rem 0 2rem;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-form-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .rental-form-section {
                position: static;
            }

            .main-image {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .car-detail-container {
                padding: 0 1rem;
                margin: 80px auto 2rem;
            }

            .main-image {
                height: 300px;
            }

            .car-details {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .features-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .car-images-section,
            .car-content,
            .rental-form {
                padding: 1.5rem;
            }

            .main-image {
                height: 250px;
            }

            .car-title {
                font-size: 1.5rem;
            }

            .car-price {
                font-size: 1.25rem;
            }
        }
        
        /* Styles cho map */
        #locationMap {
            width: 100%;
            height: 300px;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        
        .map-controls {
            display: flex;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .map-search {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .map-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            color: var(--primary-color);
            font-size: 2rem;
            z-index: 100;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        
        .selected-location {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
    </style>
    <!-- Google Maps API - Đã thay đổi cách tải script để tránh lỗi -->
    <script>
        // Biến toàn cục cho map, geocoder, infowindow, selectedPosition và autocomplete
        let map, geocoder, infowindow, selectedPosition, autocomplete;
        
        // Hàm callback sẽ được gọi sau khi Google Maps API được tải
        function initMap() {
            console.log("Đang khởi tạo Google Maps...");
            
            // Kiểm tra nếu phần tử bản đồ đã được tạo
            const mapElement = document.getElementById("locationMap");
            if (!mapElement) {
                console.error("Không tìm thấy phần tử locationMap");
                return;
            }
            
            try {
                // Vị trí mặc định (Tp. Hồ Chí Minh)
                const defaultLocation = { lat: 10.762622, lng: 106.660172 };
                
                // Tạo map với tùy chọn cơ bản
                map = new google.maps.Map(mapElement, {
                    center: defaultLocation,
                    zoom: 13,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });
                
                // Tạo geocoder để chuyển đổi tọa độ thành địa chỉ và ngược lại
                geocoder = new google.maps.Geocoder();
                infowindow = new google.maps.InfoWindow();
                
                // Đánh dấu vị trí mặc định ban đầu
                const marker = new google.maps.Marker({
                    position: defaultLocation,
                    map: map,
                    title: "Vị trí đã chọn",
                    animation: google.maps.Animation.DROP
                });
                
                // Tạo autocomplete cho ô tìm kiếm sau khi bản đồ đã được tạo
                setTimeout(() => {
                    const input = document.getElementById("mapSearch");
                    if (input) {
                        autocomplete = new google.maps.places.Autocomplete(input);
                        autocomplete.bindTo("bounds", map);
                        
                        // Sự kiện khi chọn một địa điểm từ autocomplete
                        autocomplete.addListener("place_changed", () => {
                            const place = autocomplete.getPlace();
                            
                            if (!place.geometry || !place.geometry.location) {
                                return;
                            }
                            
                            // Nếu nơi này có viewport thì hiển thị nó, không thì zoom đến vị trí
                            if (place.geometry.viewport) {
                                map.fitBounds(place.geometry.viewport);
                            } else {
                                map.setCenter(place.geometry.location);
                                map.setZoom(17);
                            }
                            
                            // Di chuyển marker đến vị trí mới
                            marker.setPosition(place.geometry.location);
                            
                            // Cập nhật vị trí đã chọn
                            selectedPosition = {
                                lat: place.geometry.location.lat(),
                                lng: place.geometry.location.lng(),
                                address: place.formatted_address
                            };
                            
                            // Hiển thị địa chỉ đã chọn
                            showSelectedLocation();
                            
                            // Cập nhật input location
                            document.getElementById("customLocation").value = place.formatted_address;
                            
                            // Đảm bảo tab custom location được chọn
                            document.querySelectorAll('.delivery-option').forEach(option => {
                                option.classList.remove('active');
                            });
                            document.querySelector('.delivery-option:nth-child(3)').classList.add('active');
                        });
                    }
                }, 500);
                
                // Sự kiện khi click vào map
                map.addListener("click", (e) => {
                    // Lấy tọa độ của điểm click
                    const clickedPosition = {
                        lat: e.latLng.lat(),
                        lng: e.latLng.lng()
                    };
                    
                    // Di chuyển marker
                    marker.setPosition(e.latLng);
                    
                    // Chuyển tọa độ thành địa chỉ
                    geocodePosition(clickedPosition);
                    
                    // Đảm bảo tab custom location được chọn
                    document.querySelectorAll('.delivery-option').forEach(option => {
                        option.classList.remove('active');
                    });
                    document.querySelector('.delivery-option:nth-child(3)').classList.add('active');
                });
                
                // Lưu trữ marker trong biến toàn cục để sử dụng sau này
                window.currentMarker = marker;
                
                console.log("Google Maps đã được khởi tạo thành công!");
            } catch (error) {
                console.error("Lỗi khi khởi tạo bản đồ:", error);
                // Hiển thị thông báo lỗi cho người dùng
                mapElement.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>Không thể tải Google Maps. Vui lòng thử lại sau.</p>
                        <button onclick="loadGoogleMaps()" class="btn-rent" style="max-width: 200px; margin: 10px auto;">
                            <i class="fas fa-sync"></i> Thử lại
                        </button>
                    </div>
                `;
            }
        }
        
        // Hàm chuyển đổi tọa độ thành địa chỉ
        function geocodePosition(pos) {
            geocoder.geocode({
                location: pos
            }, (results, status) => {
                if (status === google.maps.GeocoderStatus.OK && results[0]) {
                    // Cập nhật vị trí đã chọn
                    selectedPosition = {
                        lat: pos.lat,
                        lng: pos.lng,
                        address: results[0].formatted_address
                    };
                    
                    // Hiển thị địa chỉ đã chọn
                    showSelectedLocation();
                    
                    // Cập nhật input customLocation với địa chỉ đã chọn
                    document.getElementById("customLocation").value = results[0].formatted_address;
                    
                    // Tùy chọn: hiển thị infowindow trên bản đồ
                    if (infowindow) {
                        infowindow.setContent(results[0].formatted_address);
                        infowindow.open(map, window.currentMarker);
                    }
                } else {
                    console.error('Không thể lấy địa chỉ từ vị trí này: ' + status);
                }
            });
        }
        
        // Hiển thị địa chỉ đã chọn
        function showSelectedLocation() {
            const selectedLocationElement = document.getElementById("selectedLocation");
            const selectedLocationTextElement = document.getElementById("selectedLocationText");
            
            if (selectedPosition && selectedPosition.address) {
                selectedLocationElement.style.display = "block";
                selectedLocationTextElement.textContent = selectedPosition.address;
            } else {
                selectedLocationElement.style.display = "none";
            }
        }
        
        // Lấy vị trí hiện tại của người dùng
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(pos);
                        map.setZoom(17);
                        
                        if (window.currentMarker) {
                            window.currentMarker.setPosition(pos);
                        }
                        
                        geocodePosition(pos);
                    },
                    (error) => {
                        console.error("Lỗi khi lấy vị trí hiện tại:", error);
                        alert("Không thể lấy vị trí hiện tại. Vui lòng kiểm tra quyền truy cập vị trí của trình duyệt.");
                    }
                );
            } else {
                alert("Trình duyệt của bạn không hỗ trợ định vị.");
            }
        }
        
        // Hàm tải Google Maps API
        function loadGoogleMaps() {
            const mapElement = document.getElementById("locationMap");
            if (mapElement) {
                mapElement.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>Đang tải bản đồ...</p>
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                `;
            }
            
            // Xóa script cũ nếu có
            const oldScript = document.getElementById("google-maps-api");
            if (oldScript) {
                oldScript.remove();
            }
            
            // Tạo script mới
            const script = document.createElement("script");
            script.id = "google-maps-api";
            script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDaIUWnCuFx_EHEqade7WElJholfTrEONU&libraries=places&callback=initMap";
            script.async = true;
            script.defer = true;
            
            // Xử lý lỗi tải script
            script.onerror = function() {
                const mapElement = document.getElementById("locationMap");
                if (mapElement) {
                    mapElement.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p>Không thể tải Google Maps. Vui lòng thử lại sau.</p>
                            <button onclick="loadGoogleMaps()" class="btn-rent" style="max-width: 200px; margin: 10px auto;">
                                <i class="fas fa-sync"></i> Thử lại
                            </button>
                        </div>
                    `;
                }
            };
            
            // Thêm script vào document
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <div class="logo-header">
                <a href="/public/index.html">
                    <img src="/public/image/AutomotiveCar.png" alt="TKĐK Logo" class="logo">
                </a>
            </div>
            <nav class="menu-header">
                <ul class="menu">
                    <li class="menu-item"><a href="/public/index.html"><i class="fas fa-home"></i> Trang chủ</a></li>
                    <li class="menu-item"><a href="/public/index.html#gioithieu"><i class="fas fa-info-circle"></i> Giới thiệu</a></li>
                    <li class="menu-item">
                        <a href="#"><i class="fas fa-car"></i> Dịch vụ <i class="fas fa-chevron-down"></i></a>
                        <ul class="sub-menu">
                            <li><a href="/views/Xe4cho.html">Thuê xe 4 chỗ</a></li>
                            <li><a href="/views/Xe7cho.html">Thuê xe 7 chỗ</a></li>
                            <li><a href="/views/Xe16cho.html">Thuê xe 16 chỗ</a></li>
                        </ul>
                    </li>
                    <li class="menu-item"><a href="/views/DanhSachXeChoThue.html"><i class="fas fa-list"></i> Danh sách xe</a></li>
                    <li class="menu-item"><a href="/views/LienHe.html"><i class="fas fa-phone"></i> Liên hệ</a></li>
                </ul>
            </nav>
            <div class="login-header guest-only">
                <a href="/views/login.html" class="btn btn-login">
                    <i class="fas fa-user"></i> Đăng nhập
                </a>
            </div>
        </div>    </header>

    <!-- Main Content -->
    <main class="car-detail-container">
        <!-- Car Images Section -->
        <section class="car-images-section">
            <img id="mainImage" src="/public/image/lazy.svg" alt="Hình ảnh xe" class="main-image">
            <div class="image-gallery">
                <!-- Thumbnails will be added dynamically -->
            </div>
        </section>

        <!-- Grid Layout for Content and Form -->
        <div class="content-form-grid">
            <!-- Car Content Section (Left) -->
            <div class="car-content">
                <div class="car-header">
                    <h1 class="car-title">Đang tải thông tin xe...</h1>
                    <div class="car-price">Đang tải...</div>
                    <span class="car-status status-available">
                        <i class="fas fa-check-circle"></i>
                        Đang kiểm tra tình trạng
                    </span>
                </div>

                <!-- Owner Information -->
                <div class="owner-info">
                    <img src="/public/image/lazy.svg" alt="Owner" class="owner-avatar">
                    <div class="owner-details">
                        <h4>Chủ xe: Đang tải thông tin...</h4>
                        <p>Liên hệ: <span id="ownerContact">Đang tải thông tin...</span></p>
                    </div>
                </div>

                <!-- Car Details -->
                <h3>Thông số kỹ thuật</h3>
                <div class="car-details">
                    <!-- Car details will be added dynamically -->
                </div>

                <!-- Car Description -->
                <div class="car-description">
                    <h3>Mô tả xe</h3>
                    <p>Đang tải mô tả xe...</p>
                </div>

                <!-- Car Features -->
                <h3>Tính năng nổi bật</h3>
                <div class="features-list">
                    <!-- Features will be added dynamically -->
                </div>
            </div>

            <!-- Rental Form Section (Right) -->
            <section class="rental-form-section">
                <div class="rental-form">
                    <h3>Đặt thuê xe</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="startDate">Ngày bắt đầu</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">Ngày kết thúc</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deliveryLocation">Địa điểm giao nhận xe</label>
                        <input type="text" id="deliveryLocation" class="form-control" readonly placeholder="Chọn địa điểm giao nhận xe" onclick="openLocationPopup()">
                    </div>
                    <div class="form-group">
                        <label for="promoCode">Mã khuyến mãi (nếu có)</label>
                        <input type="text" id="promoCode" class="form-control" placeholder="Nhập mã khuyến mãi">
                        <div id="promoMessage" style="margin-top: 0.5rem; font-size: 0.875rem; display: none;"></div>
                    </div>

                    <div class="price-calculator">
                        <h4>Chi tiết giá</h4>
                        <div class="price-item">
                            <span>Giá thuê</span>
                            <span>0 VNĐ</span>
                        </div>
                        <div class="price-item">
                            <span>Phí dịch vụ</span>
                            <span>100.000 VNĐ</span>
                        </div>
                        <div class="price-item">
                            <span>Giảm giá</span>
                            <span>0 VNĐ</span>
                        </div>
                        <div class="price-total">
                            <span>Tổng cộng</span>
                            <span>0 VNĐ</span>
                        </div>
                    </div>

                    <button class="btn-rent" onclick="rentCar()">
                        <i class="fas fa-car"></i>
                        Thuê xe ngay
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- Overlay for Popups -->
    <div id="overlay" class="overlay"></div>

    <!-- Location Popup -->
    <div id="locationPopup" class="location-popup">
        <h3>Chọn địa điểm giao nhận xe</h3>
        
        <div class="map-controls">
            <input type="text" id="mapSearch" class="map-search" placeholder="Tìm kiếm địa điểm...">
            <button onclick="getCurrentLocation()" class="btn-rent" style="padding: 0.5rem; width: auto; margin: 0;">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>
        
        <div id="locationMap" style="position: relative; height: 300px; border-radius: 12px; overflow: hidden;">
            <div style="text-align: center; padding-top: 120px;">
                <p>Đang tải bản đồ...</p>
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>
        
        <div id="selectedLocation" class="selected-location">
            <i class="fas fa-map-marker-alt"></i>
            <span id="selectedLocationText">Chưa chọn địa điểm</span>
        </div>
        
        <div class="delivery-options">
            <div class="delivery-option active" onclick="selectDeliveryOption(this, 'default')">
                <h4 class="delivery-title">Tại trụ sở công ty - HuTech</h4>
                <input type="hidden" value="default">
                <p>Giao nhận xe tại địa điểm mặc định</p>
            </div>
            <div class="delivery-option" onclick="selectDeliveryOption(this, 'airport')">
                <h4 class="delivery-title">Sân bay Tân Sơn Nhất</h4>
                <input type="hidden" value="airport">
                <p>Giao nhận xe tại sân bay (Phí: 150.000đ)</p>
            </div>
            <div class="delivery-option" onclick="selectDeliveryOption(this, 'custom')">
                <h4 class="delivery-title">Địa điểm tùy chọn</h4>
                <input type="hidden" value="custom">
                <p>Chọn vị trí trên bản đồ hoặc nhập địa chỉ</p>
                <input type="text" id="customLocation" class="form-control" placeholder="Nhập địa chỉ...">
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button class="btn-rent" style="background: var(--error-color)" onclick="closeLocationPopup()">Hủy</button>
            <button class="btn-rent" onclick="confirmLocation()">Xác nhận</button>
        </div>
    </div>

    <!-- Promo Popup -->
    <div id="promoPopup" class="promo-popup">
        <h3>Mã khuyến mãi có sẵn</h3>
        
        <div style="display: flex; flex-direction: column; gap: 1rem; margin: 1.5rem 0;">
            <div class="delivery-option" onclick="selectPromo('DISCOUNT10', 10)">
                <h4>DISCOUNT10</h4>
                <p>Giảm 10% tổng giá trị đơn hàng</p>
            </div>
            <div class="delivery-option" onclick="selectPromo('DISCOUNT20', 20)">
                <h4>DISCOUNT20</h4>
                <p>Giảm 20% tổng giá trị đơn hàng</p>
            </div>
            <div class="delivery-option" onclick="selectPromo('SUMMER2025', 15)">
                <h4>SUMMER2025</h4>
                <p>Giảm 15% cho chương trình hè 2025</p>
            </div>
        </div>
        
        <button class="btn-rent" onclick="closePromoPopup()">Đóng</button>
    </div>

    <script>
        // Các biến toàn cục
        let currentDiscount = 0;
        
        // Lấy ID xe từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const carId = urlParams.get('id');
        console.log('Car ID from URL:', carId);

        // Thiết lập debug info
        document.addEventListener('DOMContentLoaded', function() {
            const debugCarId = document.getElementById('debug-car-id');
            if (debugCarId) {
                debugCarId.textContent = carId || 'Không tìm thấy';
            }
            
            // Tải dữ liệu xe
            fetchCarDetails();
            
            // Thiết lập ngày tối thiểu cho form
            setupDateInputs();
            
            // Thiết lập sự kiện đổi ngày
            document.getElementById('startDate').addEventListener('change', updatePrice);
            document.getElementById('endDate').addEventListener('change', updatePrice);
            
            // Ẩn panel debug sau 3 giây nếu không có lỗi
            setTimeout(() => {
                const debugInfo = document.getElementById('debug-info');
                const debugApiStatus = document.getElementById('debug-api-status');
                if (debugInfo && debugApiStatus && !debugApiStatus.textContent.includes('Lỗi')) {
                    debugInfo.style.display = 'none';
                }
            }, 3000);
        });

        // Hàm lấy chi tiết xe từ API
        async function fetchCarDetails() {
            try {
                console.log('Đang lấy thông tin xe có ID:', carId);
                
                // Kiểm tra ID xe
                if (!carId) {
                    console.error('Không tìm thấy ID xe trong URL');
                    document.getElementById('debug-api-status').textContent = 'Lỗi: Thiếu ID xe';
                    alert('Không tìm thấy ID xe. Vui lòng quay lại danh sách xe và thử lại.');
                    return;
                }
                
                // Tạo URL API
                const apiUrl = `/api/cars/${carId}`;
                console.log('URL API:', apiUrl);
                
                // Gửi request đến API với timeout 5 giây
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                try {
                    const response = await fetch(apiUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    console.log('Trạng thái phản hồi API:', response.status, response.statusText);
                    
                    // Cập nhật debug info
                    const debugApiStatus = document.getElementById('debug-api-status');
                    if (debugApiStatus) {
                        debugApiStatus.textContent = `${response.status} - ${response.statusText}`;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Dữ liệu xe nhận được:', data);
                    
                    if (data && data.success) {
                        // Hiển thị chi tiết xe từ API
                        displayCarDetails(data);
                    } else {
                        console.error('API trả về thành công nhưng dữ liệu không hợp lệ:', data);
                        throw new Error('Dữ liệu API không hợp lệ');
                    }
                } catch (error) {
                    console.error('Lỗi khi gọi API:', error.message);
                    
                    // Cập nhật debug info
                    const debugApiStatus = document.getElementById('debug-api-status');
                    if (debugApiStatus) {
                        debugApiStatus.textContent = `Lỗi: ${error.message}`;
                    }
                    
                    // Hiển thị dữ liệu mẫu khi API không hoạt động
                    displaySampleCarDetails();
                }
            } catch (error) {
                console.error('Lỗi khi lấy thông tin xe:', error);
                
                // Hiển thị dữ liệu mẫu nếu có lỗi
                displaySampleCarDetails();
            }
        }

        // Hàm hiển thị dữ liệu mẫu khi API không hoạt động
        function displaySampleCarDetails() {
            console.log('Đang sử dụng dữ liệu mẫu cho xe ID:', carId);
            
            // Tạo dữ liệu mẫu dựa trên ID
            let car = null;
            
            switch(carId) {
                case '1':
                    car = {
                        id: 1,
                        ten_xe: 'Mercedes C300 AMG 2024',
                        hinh_anh: ['/public/image/MercedesC300.png'],
                        so_cho: 4,
                        hop_so: 'tu_dong',
                        nhien_lieu: 'xang',
                        gia_thue: 2000000,
                        mo_ta: 'Mercedes C300 AMG là mẫu sedan hạng sang với thiết kế thể thao, động cơ mạnh mẽ và trang bị tiện nghi cao cấp. Xe phù hợp cho những người yêu thích trải nghiệm lái xe đẳng cấp.',
                        hang_xe: 'Mercedes',
                        ten_chu_xe: 'TKĐK Car Rental',
                        lien_he_chu_xe: '0397468827',
                        danh_gia: '4.8',
                        tinh_trang: 'san_sang',
                        features: ['Hệ thống âm thanh 12 loa', 'Cửa sổ trời panorama', 'Ghế da cao cấp', 'Hệ thống lái trợ lực điện', 'Camera 360 độ', 'Cảm biến đỗ xe']
                    };
                    break;
                
                case '2':
                    car = {
                        id: 2,
                        ten_xe: 'VinFast VF6 2024',
                        hinh_anh: ['/public/image/VINFASTvf62024.png'],
                        so_cho: 5,
                        hop_so: 'tu_dong',
                        nhien_lieu: 'dien',
                        gia_thue: 1500000,
                        mo_ta: 'VinFast VF6 là mẫu SUV điện cỡ trung với thiết kế hiện đại, không gian nội thất rộng rãi và công nghệ thông minh. Xe phù hợp cho gia đình và di chuyển trong đô thị.',
                        hang_xe: 'VinFast',
                        ten_chu_xe: 'TKĐK Car Rental',
                        lien_he_chu_xe: '0397468827',
                        danh_gia: '4.9',
                        tinh_trang: 'san_sang',
                        features: ['Màn hình cảm ứng 15.6 inch', 'Hệ thống hỗ trợ lái nâng cao', 'Pin LFP dung lượng lớn', 'Trợ lý ảo thông minh', 'Sạc nhanh 70% trong 30 phút', 'Cảm biến va chạm 360 độ']
                    };
                    break;
                    
                case '3':
                    car = {
                        id: 3,
                        ten_xe: 'Ford Transit 16 Chỗ',
                        hinh_anh: ['/public/image/Xe16Cho.png'],
                        so_cho: 16,
                        hop_so: 'so_san',
                        nhien_lieu: 'dau',
                        gia_thue: 2500000,
                        mo_ta: 'Ford Transit 16 chỗ là mẫu xe thương mại phù hợp cho việc đưa đón nhân viên, du lịch nhóm hoặc chở khách. Với thiết kế rộng rãi, bền bỉ và tiết kiệm nhiên liệu.',
                        hang_xe: 'Ford',
                        ten_chu_xe: 'TKĐK Car Rental',
                        lien_he_chu_xe: '0397468827',
                        danh_gia: '4.7',
                        tinh_trang: 'dang_thue',
                        features: ['16 ghế ngồi thoải mái', 'Máy lạnh 2 dàn', 'Hệ thống âm thanh 6 loa', 'Cửa lùa hai bên', 'Động cơ diesel tiết kiệm', 'Hệ thống phanh ABS']
                    };
                    break;
                    
                case '4':
                    car = {
                        id: 4,
                        ten_xe: 'Toyota Camry 2.5Q 2024',
                        hinh_anh: ['/public/image/ToyotaCamry.png'],
                        so_cho: 5,
                        hop_so: 'tu_dong',
                        nhien_lieu: 'xang',
                        gia_thue: 1800000,
                        mo_ta: 'Toyota Camry là mẫu sedan hạng D nổi tiếng với độ bền bỉ, không gian rộng rãi và tiện nghi cao cấp. Phiên bản 2.5Q sở hữu động cơ mạnh mẽ và nhiều tính năng an toàn hiện đại.',
                        hang_xe: 'Toyota',
                        ten_chu_xe: 'TKĐK Car Rental',
                        lien_he_chu_xe: '0397468827',
                        danh_gia: '4.9',
                        tinh_trang: 'san_sang',
                        features: ['Màn hình giải trí 9 inch', 'Camera 360', 'Cửa sổ trời', 'Ghế da cao cấp', 'Hệ thống âm thanh JBL', 'Cảm biến đỗ xe']
                    };
                    break;
                    
                case '5':
                    car = {
                        id: 5,
                        ten_xe: 'Toyota Fortuner 2.8AT 4x4 2023',
                        hinh_anh: ['/public/image/ToyotaFortuner.jpeg'],
                        so_cho: 7,
                        hop_so: 'tu_dong',
                        nhien_lieu: 'dau',
                        gia_thue: 1600000,
                        mo_ta: 'Toyota Fortuner là mẫu SUV đa dụng 7 chỗ với khả năng off-road vượt trội. Phiên bản 2.8AT 4x4 với động cơ dầu mạnh mẽ, hệ dẫn động 4 bánh và trang bị tiện nghi đầy đủ.',
                        hang_xe: 'Toyota',
                        ten_chu_xe: 'TKĐK Car Rental',
                        lien_he_chu_xe: '0397468827',
                        danh_gia: '4.8',
                        tinh_trang: 'san_sang',
                        features: ['Dẫn động 4 bánh', 'Màn hình giải trí 8 inch', 'Ghế bọc da', 'Camera lùi', 'Cruise Control', 'Hệ thống kiểm soát lực kéo']
                    };
                    break;
                    
                default:
                    // Xe mặc định nếu không khớp với ID nào
                    car = {
                        id: carId,
                        ten_xe: 'Xe mẫu',
                        hinh_anh: ['/public/image/lazy.svg'],
                        so_cho: 4,
                        hop_so: 'tu_dong',
                        nhien_lieu: 'xang',
                        gia_thue: 1000000,
                        mo_ta: 'Thông tin chi tiết về xe chưa được cập nhật.',
                        hang_xe: 'TKĐK',
                        ten_chu_xe: 'TKĐK Car Rental',
                        lien_he_chu_xe: '0397468827',
                        danh_gia: '5.0',
                        tinh_trang: 'san_sang',
                        features: [
                            'Bảo hiểm 2 chiều',
                            'Giao xe tận nơi',
                            'Bluetooth/USB/AUX',
                            'Bản đồ dẫn đường',
                            'Camera lùi',
                            'Cảm biến va chạm'
                        ]
                    };
            }
            
            const mockData = {
                success: true,
                message: 'Lấy thông tin xe thành công (dữ liệu mẫu)',
                data: car
            };
            
            // Hiển thị dữ liệu mẫu
            displayCarDetails(mockData);
        }

        // Hiển thị chi tiết xe
        function displayCarDetails(carData) {
            if (!carData || !carData.success || !carData.data) {
                console.error('Nhận được dữ liệu không hợp lệ:', carData);
                return;
            }

            // Lấy dữ liệu xe từ phản hồi API
            const car = carData.data;
            console.log('Đang xử lý dữ liệu xe:', car);

            // Cập nhật tiêu đề trang
            document.title = `${car.ten_xe} - TKĐK Car Rental`;

            // Cập nhật hình ảnh chính và thumbnail
            const mainImage = document.getElementById('mainImage');
            const imageGallery = document.querySelector('.image-gallery');
            
            // Xử lý hình ảnh - nếu hinh_anh là mảng, sử dụng trực tiếp, nếu không tạo mảng với hình ảnh đơn lẻ
            let carImages = [];
            
            if (Array.isArray(car.hinh_anh)) {
                carImages = car.hinh_anh;
            } else if (car.hinh_anh) {
                carImages = [car.hinh_anh];
            } else {
                carImages = ['/public/image/lazy.svg'];
            }
            
            // Xử lý đường dẫn hình ảnh để đảm bảo chúng đầy đủ
            carImages = carImages.map(img => {
                if (img.startsWith('/image/')) {
                    return '/public' + img;
                }
                if (!img.startsWith('/') && !img.startsWith('http')) {
                    return '/public/image/' + img;
                }
                return img;
            });
            
            // Thiết lập hình ảnh chính
            mainImage.src = carImages[0] || '/public/image/lazy.svg';
            mainImage.alt = car.ten_xe;
            
            // Thiết lập thumbnails
            imageGallery.innerHTML = carImages.map((image, index) => `
                <img src="${image}" 
                     alt="${car.ten_xe} - ${index + 1}" 
                     class="thumbnail ${index === 0 ? 'active' : ''}" 
                     onclick="changeImage(this)"
                     onerror="this.src='/public/image/lazy.svg'">
            `).join('');

            // Cập nhật thông tin xe
            document.querySelector('.car-title').textContent = car.ten_xe;
            document.querySelector('.car-price').textContent = `${formatCurrency(car.gia_thue)}/ngày`;
            
            // Cập nhật trạng thái xe
            const statusElement = document.querySelector('.car-status');
            if (car.tinh_trang === 'san_sang') {
                statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Có sẵn';
                statusElement.className = 'car-status status-available';
                
                // Đảm bảo nút thuê xe hoạt động
                const rentButton = document.querySelector('.btn-rent');
                rentButton.disabled = false;
                rentButton.innerHTML = '<i class="fas fa-car"></i> Thuê xe ngay';
            } else {
                statusElement.innerHTML = '<i class="fas fa-clock"></i> Đã được thuê';
                statusElement.className = 'car-status status-unavailable';
                
                // Vô hiệu hóa nút thuê xe
                const rentButton = document.querySelector('.btn-rent');
                rentButton.disabled = true;
                rentButton.innerHTML = 'Xe đã được thuê';
            }
            
            // Cập nhật thông tin chủ xe
            document.querySelector('.owner-details h4').textContent = `Chủ xe: ${car.ten_chu_xe || 'TKĐK Car Rental'}`;
            document.getElementById('ownerContact').textContent = car.lien_he_chu_xe || '0397468827';
            
            // Xử lý loại hộp số và nhiên liệu
            let hopSoText = 'Số sàn';
            if (car.hop_so === 'tu_dong') {
                hopSoText = 'Tự động';
            }
            
            let nhienLieuText = 'Xăng';
            switch(car.nhien_lieu) {
                case 'xang': nhienLieuText = 'Xăng'; break;
                case 'dau': nhienLieuText = 'Dầu'; break;
                case 'dien': nhienLieuText = 'Điện'; break;
                case 'hybrid': nhienLieuText = 'Hybrid'; break;
            }
            
            // Cập nhật chi tiết xe
            const detailsHTML = `
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="detail-info">
                        <h4>Hãng xe</h4>
                        <p>${car.hang_xe}</p>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fa-solid fa-chair"></i>
                    </div>
                    <div class="detail-info">
                        <h4>Số ghế</h4>
                        <p>${car.so_cho} chỗ</p>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="detail-info">
                        <h4>Hộp số</h4>
                        <p>${hopSoText}</p>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">
                        <i class="fas fa-gas-pump"></i>
                    </div>
                    <div class="detail-info">
                        <h4>Nhiên liệu</h4>
                        <p>${nhienLieuText}</p>
                    </div>
                </div>
            `;
            document.querySelector('.car-details').innerHTML = detailsHTML;

            // Cập nhật mô tả xe
            document.querySelector('.car-description p').textContent = car.mo_ta || 'Không có mô tả cho xe này.';

            // Cập nhật danh sách tính năng với các tính năng mặc định nếu không được cung cấp
            const defaultFeatures = [
                'Bảo hiểm 2 chiều',
                'Giao xe tận nơi',
                'Bluetooth/USB/AUX',
                'Bản đồ dẫn đường',
                'Camera lùi',
                'Cảm biến va chạm'
            ];
            
            const featuresHTML = (car.features || defaultFeatures).map(feature => `
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>${feature}</span>
                </div>
            `).join('');
            document.querySelector('.features-list').innerHTML = featuresHTML;

            // Cập nhật bộ tính giá thuê
            updatePrice();
        }

        // Thiết lập ngày tối thiểu cho form đặt xe
        function setupDateInputs() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput && endDateInput) {
                startDateInput.min = today.toISOString().split('T')[0];
                endDateInput.min = tomorrow.toISOString().split('T')[0];
                
                // Thiết lập ngày mặc định
                startDateInput.value = today.toISOString().split('T')[0];
                endDateInput.value = tomorrow.toISOString().split('T')[0];
            }
        }

        // Cập nhật chức năng tính giá
        function updatePrice() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (!startDateInput || !endDateInput) return;
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (startDate && endDate && startDate < endDate) {
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                // Lấy giá từ hiển thị hiện tại hoặc giá trị mặc định
                let basePricePerDay = 0;
                const priceText = document.querySelector('.car-price').textContent;
                const match = priceText.match(/([0-9,.]+)/);
                if (match) {
                    basePricePerDay = parseInt(match[0].replace(/[,.]/g, ''));
                }
                
                const totalRent = basePricePerDay * days;
                const serviceFee = 100000;
                const total = totalRent + serviceFee - currentDiscount;

                // Cập nhật hiển thị giá
                const priceItems = document.querySelectorAll('.price-item span:last-child');
                if (priceItems.length >= 3) {
                    priceItems[0].textContent = `${formatCurrency(totalRent)}`;
                    priceItems[2].textContent = `${formatCurrency(-currentDiscount)}`;
                }
                
                const totalElement = document.querySelector('.price-total span:last-child');
                if (totalElement) {
                    totalElement.textContent = `${formatCurrency(total)}`;
                }
            }
        }

        // Các hàm bổ trợ
        function changeImage(element) {
            const mainImage = document.getElementById('mainImage');
            if (mainImage) {
                mainImage.src = element.src;
                
                document.querySelectorAll('.thumbnail').forEach(thumb => {
                    thumb.classList.remove('active');
                });
                element.classList.add('active');
            }
        }

        function rentCar() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const deliveryLocationInput = document.getElementById('deliveryLocation');
            
            if (!startDateInput || !endDateInput || !deliveryLocationInput) return;
            
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const location = deliveryLocationInput.value;
            
            if (!startDate || !endDate) {
                alert('Vui lòng chọn ngày bắt đầu và kết thúc');
                return;
            }
            
            if (!location) {
                alert('Vui lòng chọn địa điểm giao nhận xe');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start >= end) {
                alert('Ngày kết thúc phải sau ngày bắt đầu');
                return;
            }

            // Lấy thông tin giá từ các phần tử hiện tại
            const basePriceText = document.querySelector('.price-item:first-child span:last-child').textContent;
            const totalText = document.querySelector('.price-total span:last-child').textContent;
            
            // Trích xuất giá trị số
            const basePrice = parseInt(basePriceText.replace(/[^\d]/g, ''));
            const total = parseInt(totalText.replace(/[^\d]/g, ''));
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            
            // Chuyển hướng đến trang HoaDon.html với các tham số
            const params = new URLSearchParams({
                carId: carId,
                startDate: startDate,
                endDate: endDate,
                location: location,
                totalAmount: total,
                basePrice: basePrice,
                serviceFee: 100000,
                discount: currentDiscount,
                days: days
            });
            
            window.location.href = `HoaDon.html?${params.toString()}`;
        }

        // Định dạng tiền tệ VND
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Kiểm tra mã khuyến mãi
        function checkPromoCode() {
            const promoCodeInput = document.getElementById('promoCode');
            const promoMessage = document.getElementById('promoMessage');
            
            if (!promoCodeInput || !promoMessage) return;
            
            const promoCode = promoCodeInput.value.trim().toUpperCase();

            // Mã khuyến mãi mô phỏng - trong ứng dụng thực, những mã này nên được xác minh với máy chủ
            const promoCodes = {
                'DISCOUNT10': { discount: 0.1, message: 'Giảm 10% tổng giá trị đơn hàng' },
                'DISCOUNT20': { discount: 0.2, message: 'Giảm 20% tổng giá trị đơn hàng' },
                'SUMMER2025': { discount: 0.15, message: 'Giảm 15% cho chương trình hè 2025' }
            };

            if (promoCodes[promoCode]) {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (!startDateInput || !endDateInput) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (!startDate || !endDate) {
                    promoMessage.textContent = "Vui lòng chọn ngày thuê trước khi áp dụng mã giảm giá";
                    promoMessage.style.color = "red";
                    promoMessage.style.display = "block";
                    return;
                }

                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                // Lấy giá từ hiển thị hiện tại
                let basePricePerDay = 0;
                const priceText = document.querySelector('.car-price').textContent;
                const match = priceText.match(/([0-9,.]+)/);
                if (match) {
                    basePricePerDay = parseInt(match[0].replace(/[,.]/g, ''));
                }
                const totalRent = basePricePerDay * days;
                currentDiscount = totalRent * promoCodes[promoCode].discount;
                
                promoMessage.textContent = `${promoCodes[promoCode].message} (-${formatCurrency(currentDiscount)})`;
                promoMessage.style.color = "green";
                promoMessage.style.display = "block";
                updatePrice();
            } else {
                promoMessage.textContent = "Mã khuyến mãi không hợp lệ hoặc đã hết hạn.";
                promoMessage.style.color = "red";
                promoMessage.style.display = "block";
                currentDiscount = 0;
                updatePrice();
            }
        }

        // Hiển thị popup khuyến mãi khi nhấp vào input khuyến mãi
        document.addEventListener('DOMContentLoaded', function() {
            const promoCodeInput = document.getElementById('promoCode');
            const overlay = document.getElementById('overlay');
            
            if (promoCodeInput) {
                promoCodeInput.addEventListener('click', function() {
                    if (overlay) {
                        overlay.style.display = 'block';
                    }
                    
                    const promoPopup = document.getElementById('promoPopup');
                    if (promoPopup) {
                        promoPopup.style.display = 'block';
                    }
                });
            }
        });

        // Đóng popup khuyến mãi
        function closePromoPopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('promoPopup').style.display = 'none';
        }

        // Chọn mã khuyến mãi
        function selectPromo(code, discount) {
            const promoCodeInput = document.getElementById('promoCode');
            if (promoCodeInput) {
                promoCodeInput.value = code;
                checkPromoCode();
                closePromoPopup();
            }
        }

        // Đóng popup khi nhấp vào overlay
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('overlay');
            if (overlay) {
                overlay.addEventListener('click', function() {
                    closePromoPopup();
                    closeLocationPopup();
                });
            }
        });

        // Mở popup vị trí - sửa để tải maps khi cần
        function openLocationPopup() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('locationPopup').style.display = 'block';
            
            // Tải Google Maps khi mở popup
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                loadGoogleMaps();
            } else {
                // Nếu maps đã được tải nhưng có thể chưa được khởi tạo đúng
                setTimeout(() => {
                    if (map) {
                        google.maps.event.trigger(map, 'resize');
                    } else {
                        // Thử khởi tạo lại map
                        initMap();
                    }
                }, 500);
            }
        }

        // Đóng popup vị trí
        function closeLocationPopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('locationPopup').style.display = 'none';
        }

        // Chọn tùy chọn giao hàng
        function selectDeliveryOption(element, type) {
            document.querySelectorAll('.delivery-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Xác nhận vị trí
        function confirmLocation() {
            const selectedOption = document.querySelector('.delivery-option.active');
            const deliveryLocationInput = document.getElementById('deliveryLocation');
            
            if (!selectedOption || !deliveryLocationInput) return;
            
            let locationText = '';
            let locationType = selectedOption.querySelector('input').value;
            
            if (locationType === 'custom') {
                // Nếu đã chọn vị trí trên bản đồ
                if (selectedPosition && selectedPosition.address) {
                    locationText = selectedPosition.address;
                } else {
                    // Nếu chưa chọn vị trí nhưng có nhập địa chỉ
                    const customLocationInput = document.getElementById('customLocation');
                    if (customLocationInput && customLocationInput.value.trim() !== '') {
                        locationText = customLocationInput.value;
                    } else {
                        locationText = 'Địa điểm tùy chọn';
                    }
                }
            } else {
                const deliveryTitle = selectedOption.querySelector('.delivery-title');
                if (deliveryTitle) {
                    locationText = deliveryTitle.textContent;
                } else {
                    locationText = 'Địa điểm mặc định';
                }
            }
            
            deliveryLocationInput.value = locationText;
            
            // Đóng popup
            closeLocationPopup();
        }

        // Biến toàn cục cho map
        let marker;
        // Removed duplicate declaration of geocoder
        // Removed duplicate declaration of infowindow
        // Removed duplicate declaration of selectedPosition
        // Removed duplicate declaration of autocomplete
        // Hàm khởi tạo map
        function initMap() {
            // Vị trí mặc định (Tp. Hồ Chí Minh)
            const defaultLocation = { lat: 10.762622, lng: 106.660172 };
            
            // Tạo map
            map = new google.maps.Map(document.getElementById("locationMap"), {
                center: defaultLocation,
                zoom: 13,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
            });
            
            // Tạo geocoder để chuyển đổi tọa độ thành địa chỉ và ngược lại
            geocoder = new google.maps.Geocoder();
            infowindow = new google.maps.InfoWindow();
            
            // Tạo autocomplete cho ô tìm kiếm
            const input = document.getElementById("mapSearch");
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);
            
            // Sự kiện khi chọn một địa điểm từ autocomplete
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                
                if (!place.geometry || !place.geometry.location) {
                    return;
                }
                
                // Nếu nơi này có viewport thì hiển thị nó, không thì zoom đến vị trí
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
                
                // Cập nhật vị trí đã chọn
                selectedPosition = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    address: place.formatted_address
                };
                
                // Hiển thị địa chỉ đã chọn
                showSelectedLocation();
                
                // Cập nhật input location
                document.getElementById("customLocation").value = place.formatted_address;
                
                // Đảm bảo tab custom location được chọn
                document.querySelectorAll('.delivery-option').forEach(option => {
                    option.classList.remove('active');
                });
                document.querySelector('.delivery-option:nth-child(3)').classList.add('active');
            });
            
            // Sự kiện khi click vào map
            map.addListener("click", (e) => {
                // Lấy tọa độ của điểm click
                const clickedPosition = {
                    lat: e.latLng.lat(),
                    lng: e.latLng.lng()
                };
                
                // Chuyển tọa độ thành địa chỉ
                geocodePosition(clickedPosition);
                
                // Đảm bảo tab custom location được chọn
                document.querySelectorAll('.delivery-option').forEach(option => {
                    option.classList.remove('active');
                });
                document.querySelector('.delivery-option:nth-child(3)').classList.add('active');
            });
            
            // Sự kiện khi di chuyển map
            map.addListener("center_changed", () => {
                const center = map.getCenter();
                selectedPosition = {
                    lat: center.lat(),
                    lng: center.lng()
                };
                
                // Chuyển tọa độ mới thành địa chỉ
                geocodePosition(selectedPosition);
            });
        }
        
        // Hàm chuyển đổi tọa độ thành địa chỉ
        function geocodePosition(pos) {
            geocoder.geocode({ location: pos }, (results, status) => {
                if (status === "OK" && results[0]) {
                    // Cập nhật vị trí đã chọn
                    selectedPosition = {
                        lat: pos.lat,
                        lng: pos.lng,
                        address: results[0].formatted_address
                    };
                    
                    // Hiển thị địa chỉ đã chọn
                    showSelectedLocation();
                    
                    // Cập nhật input location
                    document.getElementById("customLocation").value = results[0].formatted_address;
                }
            });
        }
        
        // Hiển thị vị trí đã chọn
        function showSelectedLocation() {
            if (selectedPosition && selectedPosition.address) {
                const selectedLocationDiv = document.getElementById("selectedLocation");
                const selectedLocationText = document.getElementById("selectedLocationText");
                
                selectedLocationText.textContent = selectedPosition.address;
                selectedLocationDiv.style.display = "block";
            }
        }
        
        // Lấy vị trí hiện tại của người dùng
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        // Di chuyển map đến vị trí hiện tại
                        map.setCenter(pos);
                        map.setZoom(17);
                        
                        // Cập nhật vị trí đã chọn
                        selectedPosition = pos;
                        
                        // Chuyển tọa độ thành địa chỉ
                        geocodePosition(pos);
                        
                        // Đảm bảo tab custom location được chọn
                        document.querySelectorAll('.delivery-option').forEach(option => {
                            option.classList.remove('active');
                        });
                        document.querySelector('.delivery-option:nth-child(3)').classList.add('active');
                    },
                    () => {
                        // Xử lý khi người dùng từ chối chia sẻ vị trí
                        alert("Không thể xác định vị trí của bạn. Vui lòng cho phép truy cập vị trí hoặc chọn địa điểm thủ công.");
                    }
                );
            } else {
                alert("Trình duyệt của bạn không hỗ trợ định vị. Vui lòng chọn địa điểm thủ công.");
            }
        }
    </script>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Liên hệ</h3>
                    <div class="footer-contact">
                        <div class="contact-item-footer">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>HuTech</span>
                        </div>
                        <div class="contact-item-footer">
                            <i class="fas fa-phone"></i>
                            <span>0397468827</span>
                        </div>
                        <div class="contact-item-footer">
                            <i class="fas fa-envelope"></i>
                            <span>dinhkhanhvn.2004@gmail.com</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <a href="/views/AdminLogin.html" class="admin-login">
                    <p>&copy; 2025 TKĐK. Tất cả quyền được bảo lưu.</p>
                </a>
            </div>
        </div>
    </footer>
    
</body>
</html>