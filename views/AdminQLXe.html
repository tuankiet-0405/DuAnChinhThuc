<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý xe - TKĐK Admin</title>
    <link rel="stylesheet" href="/public/css/stylesAdmin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="/public/js/code.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo-header">
                <img src="../public/image/AutomotiveCar.png" alt="TKĐK Admin" />
            </div>
            <ul class="menu">
                <li><a href="AdminTrangChu.html"><i class="fas fa-chart-line"></i> Thống Kê</a></li>
                <li><a href="AdminQuanLyKH.html"><i class="fas fa-users"></i> Quản Lý Khách Hàng</a></li>
                <li><a href="AdminQLXe.html" class="active"><i class="fas fa-car"></i> Quản Lý Xe</a></li>
                <li><a href="AdminQuanLyNguoiDung.html"><i class="fas fa-user-cog"></i> Quản Lý Người Dùng</a></li>
                <li><a href="AdminGiaoDich.html"><i class="fas fa-exchange-alt"></i> Quản Lý Giao Dịch</a></li>
                <li><a href="AdminVoucher.html"><i class="fas fa-ticket-alt"></i> Quản Lý Voucher</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
            </ul>
        </div>
    </div>

    <div class="car-list-container">
        <div class="header1">
            <h2>Danh sách xe <span>(7 xe)</span></h2>
            <div class="search-add">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Tìm kiếm xe..." id="searchInput">
                </div>
                <button class="btn-add" id="addCarBtn">
                    <i class="fas fa-plus"></i>
                    Thêm xe mới
                </button>
            </div>
        </div>

        <div class="filters">
            <button class="filter-item active" data-type="all">Tất cả</button>
            <button class="filter-item" data-type="4">4 chỗ</button>
            <button class="filter-item" data-type="7">7 chỗ</button>
            <button class="filter-item" data-type="16">16 chỗ</button>
            <button class="filter-item" data-type="24">24 chỗ</button>
            <button class="filter-item" data-type="pending">Chờ duyệt</button>
        </div>

        <div class="car-table">
            <table>
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Hình ảnh</th>
                        <th>Tên xe</th>
                        <th>Biển số</th>
                        <th>Giá thuê</th>
                        <th>Loại xe</th>
                        <th>Trạng thái</th>
                        <th>Chủ xe</th>
                        <th>Tùy chọn</th>
                    </tr>
                </thead>
                <tbody id="carTableBody">
                    <tr>
                        <td>1</td>
                        <td><img src="https://i.imgur.com/qbT8JmH.jpg" alt="Mercedes" class="car-img"></td>
                        <td><a href="#" class="car-name">Mercedes C200</a></td>
                        <td>43A-9999</td>
                        <td class="car-price">6,200,000đ</td>
                        <td>4 chỗ</td>
                        <td><span class="car-status status-active">Đang hoạt động</span></td>
                        <td>Nguyễn Văn A</td>
                        <td>
                            <div class="car-actions">
                                <button class="btn-action btn-edit" title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <!-- Danh sách xe sẽ được hiển thị ở đây -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Car Modal -->
    <div class="modal" id="carModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Thêm xe mới</h3>
                <button class="btn-close">&times;</button>
            </div>
            <form id="carForm">
                <div class="form-group">
                    <label>Hình ảnh xe</label>
                    <div class="image-preview" id="imagePreview">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click để tải ảnh lên</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" hidden>
                </div>
                <div class="form-group">
                    <label>Tên xe</label>
                    <input type="text" required placeholder="Nhập tên xe">
                </div>
                <div class="form-group">
                    <label>Biển số</label>
                    <input type="text" required placeholder="Nhập biển số xe">
                </div>
                <div class="form-group">
                    <label>Giá thuê (VNĐ)</label>
                    <input type="number" required placeholder="Nhập giá thuê">
                </div>
                <div class="form-group">
                    <label>Loại xe</label>
                    <select required>
                        <option value="">Chọn loại xe</option>
                        <option value="4">4 chỗ</option>
                        <option value="7">7 chỗ</option>
                        <option value="16">16 chỗ</option>
                        <option value="24">24 chỗ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Trạng thái</label>
                    <select required>
                        <option value="active">Đang hoạt động</option>
                        <option value="maintenance">Đang bảo trì</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary">Hủy</button>
                    <button type="submit" class="btn-add">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal từ chối xe -->
    <div class="modal" id="rejectCarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Từ chối xe</h3>
                <button class="btn-close">&times;</button>
            </div>
            <form id="rejectCarForm">
                <input type="hidden" id="rejectCarId">
                <div class="form-group">
                    <label>Lý do từ chối</label>
                    <textarea required placeholder="Nhập lý do từ chối xe..." rows="4"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary">Hủy</button>
                    <button type="submit" class="btn-danger">Từ chối xe</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal xem chi tiết xe chờ duyệt -->
    <div class="modal" id="viewCarModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Chi tiết xe chờ duyệt</h3>
                <button class="btn-close">&times;</button>
            </div>
            <div class="car-detail-view">
                <div class="car-detail-header">
                    <div class="car-info">
                        <h2 id="viewCarName">Tên xe</h2>
                        <p id="viewCarPlate">Biển số</p>
                    </div>
                    <div class="car-owner">
                        <h4>Thông tin chủ xe</h4>
                        <p id="viewCarOwner">Nguyễn Văn A</p>
                        <p id="viewCarOwnerPhone">0123456789</p>
                        <p id="viewCarOwnerEmail">email@example.com</p>
                    </div>
                </div>
                
                <div class="car-images">
                    <h4>Hình ảnh xe</h4>
                    <div class="image-grid" id="viewCarImages">
                        <!-- Hình ảnh sẽ được thêm bằng JavaScript -->
                    </div>
                </div>
                
                <div class="car-info-grid">
                    <div class="car-info-item">
                        <span class="label">Hãng xe</span>
                        <span class="value" id="viewCarBrand">Toyota</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Mẫu xe</span>
                        <span class="value" id="viewCarModel">Camry</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Năm sản xuất</span>
                        <span class="value" id="viewCarYear">2020</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Loại xe</span>
                        <span class="value" id="viewCarType">4 chỗ</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Giá thuê</span>
                        <span class="value" id="viewCarPrice">850,000đ/ngày</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Nhiên liệu</span>
                        <span class="value" id="viewCarFuel">Xăng</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Truyền động</span>
                        <span class="value" id="viewCarTransmission">Tự động</span>
                    </div>
                    <div class="car-info-item">
                        <span class="label">Tiêu thụ nhiên liệu</span>
                        <span class="value" id="viewCarConsumption">7.5L/100km</span>
                    </div>
                </div>
                
                <div class="car-features">
                    <h4>Tính năng xe</h4>
                    <div class="features-list" id="viewCarFeatures">
                        <!-- Tính năng sẽ được thêm bằng JavaScript -->
                    </div>
                </div>
                
                <div class="car-documents">
                    <h4>Giấy tờ xe</h4>
                    <div class="documents-grid" id="viewCarDocuments">
                        <div class="document-item">
                            <h5>Bằng lái xe (Mặt trước)</h5>
                            <img src="" id="viewLicenseFront" class="document-img">
                        </div>
                        <div class="document-item">
                            <h5>Bằng lái xe (Mặt sau)</h5>
                            <img src="" id="viewLicenseBack" class="document-img">
                        </div>
                        <div class="document-item">
                            <h5>Đăng ký xe</h5>
                            <img src="" id="viewRegistration" class="document-img">
                        </div>
                    </div>
                </div>
                
                <div class="car-approval-actions">
                    <button class="btn-approve" id="approveCarBtn">
                        <i class="fas fa-check"></i> Duyệt xe
                    </button>
                    <button class="btn-reject" id="openRejectModalBtn">
                        <i class="fas fa-times"></i> Từ chối xe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Handle active menu item
        document.querySelectorAll('.menu a').forEach(link => {
            if (link.getAttribute('href') === location.pathname.split('/').pop()) {
                link.classList.add('active');
            }
        });

        // Biến lưu trữ dữ liệu xe
        let cars = [];
        let pendingCars = [];
        let currentCarId = null;

        // Hàm hiển thị trạng thái
        function getStatusLabel(status) {
            const statusMap = {
                'san_sang': '<span class="car-status status-active">Đang hoạt động</span>',
                'dang_thue': '<span class="car-status status-rented">Đang cho thuê</span>',
                'bao_tri': '<span class="car-status status-maintenance">Đang bảo trì</span>',
                'cho_duyet': '<span class="car-status status-pending">Chờ duyệt</span>',
                'bi_tu_choi': '<span class="car-status status-rejected">Bị từ chối</span>'
            };
            return statusMap[status] || `<span class="car-status">${status}</span>`;
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + 'đ';
        }

        // Fetch danh sách xe từ API
        async function fetchCars() {
            try {
                const response = await fetch('/api/cars');
                const data = await response.json();
                
                if (data.success) {
                    cars = data.data.filter(car => car.tinh_trang !== 'cho_duyet');
                    pendingCars = data.data.filter(car => car.tinh_trang === 'cho_duyet');
                    
                    // Hiển thị danh sách xe ban đầu
                    renderCarList('all');
                }
            } catch (error) {
                console.error('Lỗi khi tải danh sách xe:', error);
                showToast('Đã xảy ra lỗi khi tải danh sách xe', 'error');
            }
        }

        // Hiển thị danh sách xe theo bộ lọc
        function renderCarList(filterType) {
            const tableBody = document.getElementById('carTableBody');
            tableBody.innerHTML = '';
            
            // Xác định danh sách xe hiển thị dựa trên bộ lọc
            let displayCars = [];
            
            if (filterType === 'pending') {
                displayCars = pendingCars;
            } else {
                displayCars = cars.filter(car => {
                    if (filterType === 'all') return true;
                    return car.so_cho_ngoi === parseInt(filterType);
                });
            }
            
            // Cập nhật số lượng xe hiển thị
            document.querySelector('.header1 h2 span').textContent = `(${displayCars.length} xe)`;
            
            // Tạo từng hàng xe trong bảng
            displayCars.forEach((car, index) => {
                const row = document.createElement('tr');
                
                const isPending = car.tinh_trang === 'cho_duyet';
                
                // Tạo nút hành động cho từng trạng thái
                let actionButtons = '';
                if (isPending) {
                    actionButtons = `
                        <button class="btn-action btn-view" data-id="${car.id}" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-approve" data-id="${car.id}" title="Duyệt xe">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn-action btn-reject" data-id="${car.id}" title="Từ chối xe">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn-action btn-edit" data-id="${car.id}" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" data-id="${car.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
                
                // Tạo HTML cho hàng
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${car.hinh_anh_chinh || '/public/image/lazy.svg'}" alt="${car.ten_xe}" class="car-img"></td>
                    <td><a href="#" class="car-name" data-id="${car.id}">${car.ten_xe}</a></td>
                    <td>${car.bien_so}</td>
                    <td class="car-price">${formatCurrency(car.gia_thue)}</td>
                    <td>${car.so_cho_ngoi} chỗ</td>
                    <td>${getStatusLabel(car.tinh_trang)}</td>
                    <td>${car.chu_xe?.ho_ten || 'N/A'}</td>
                    <td>
                        <div class="car-actions">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Gắn sự kiện cho các nút
            attachEventListeners();
        }

        // Gắn các sự kiện
        function attachEventListeners() {
            // Sự kiện nút xem chi tiết xe
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const carId = e.currentTarget.dataset.id;
                    viewCarDetails(carId);
                });
            });
            
            // Sự kiện nút duyệt xe
            document.querySelectorAll('.btn-approve').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const carId = e.currentTarget.dataset.id;
                    approveCar(carId);
                });
            });
            
            // Sự kiện nút từ chối xe
            document.querySelectorAll('.btn-reject').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const carId = e.currentTarget.dataset.id;
                    openRejectModal(carId);
                });
            });
            
            // Sự kiện nút xóa xe
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (confirm('Bạn có chắc muốn xóa xe này?')) {
                        const carId = e.currentTarget.dataset.id;
                        deleteCar(carId);
                    }
                });
            });
            
            // Sự kiện xem chi tiết qua tên xe
            document.querySelectorAll('.car-name').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const carId = e.currentTarget.dataset.id;
                    
                    // Nếu là xe chờ duyệt thì mở modal chi tiết, nếu không thì mở modal chỉnh sửa
                    const car = [...cars, ...pendingCars].find(c => c.id.toString() === carId);
                    if (car && car.tinh_trang === 'cho_duyet') {
                        viewCarDetails(carId);
                    } else {
                        // Chỉnh sửa xe (sẽ triển khai sau)
                        console.log('Chỉnh sửa xe:', carId);
                    }
                });
            });
        }

        // Xem chi tiết xe chờ duyệt
        async function viewCarDetails(carId) {
            try {
                // Lấy thông tin chi tiết xe từ API
                const response = await fetch(`/api/cars/${carId}`);
                const data = await response.json();
                
                if (!data.success) {
                    showToast('Không thể tải thông tin xe', 'error');
                    return;
                }
                
                const car = data.data;
                currentCarId = car.id;
                
                // Điền thông tin vào modal
                document.getElementById('viewCarName').textContent = car.ten_xe;
                document.getElementById('viewCarPlate').textContent = car.bien_so;
                
                // Thông tin chủ xe
                if (car.chu_xe) {
                    document.getElementById('viewCarOwner').textContent = car.chu_xe.ho_ten;
                    document.getElementById('viewCarOwnerPhone').textContent = car.chu_xe.so_dien_thoai;
                    document.getElementById('viewCarOwnerEmail').textContent = car.chu_xe.email;
                }
                
                // Thông tin cơ bản
                document.getElementById('viewCarBrand').textContent = car.hang_xe;
                document.getElementById('viewCarModel').textContent = car.dong_xe;
                document.getElementById('viewCarYear').textContent = car.nam_san_xuat;
                document.getElementById('viewCarType').textContent = `${car.so_cho_ngoi} chỗ`;
                document.getElementById('viewCarPrice').textContent = formatCurrency(car.gia_thue) + '/ngày';
                document.getElementById('viewCarFuel').textContent = car.nhien_lieu;
                document.getElementById('viewCarTransmission').textContent = car.hop_so;
                document.getElementById('viewCarConsumption').textContent = car.tieu_hao_nhien_lieu;
                
                // Hiển thị hình ảnh xe
                const imagesContainer = document.getElementById('viewCarImages');
                imagesContainer.innerHTML = '';
                
                if (car.hinh_anh && car.hinh_anh.length) {
                    car.hinh_anh.forEach(img => {
                        const imgElement = document.createElement('div');
                        imgElement.className = 'car-image-item';
                        imgElement.innerHTML = `<img src="${img}" alt="${car.ten_xe}">`;
                        imagesContainer.appendChild(imgElement);
                    });
                } else if (car.hinh_anh_chinh) {
                    const imgElement = document.createElement('div');
                    imgElement.className = 'car-image-item';
                    imgElement.innerHTML = `<img src="${car.hinh_anh_chinh}" alt="${car.ten_xe}">`;
                    imagesContainer.appendChild(imgElement);
                }
                
                // Hiển thị tính năng xe
                const featuresContainer = document.getElementById('viewCarFeatures');
                featuresContainer.innerHTML = '';
                
                if (car.tinh_nang && car.tinh_nang.length) {
                    car.tinh_nang.forEach(feature => {
                        const featureItem = document.createElement('div');
                        featureItem.className = 'feature-item';
                        featureItem.innerHTML = `<i class="fas fa-check-circle"></i> ${feature}`;
                        featuresContainer.appendChild(featureItem);
                    });
                }
                
                // Hiển thị hình ảnh giấy tờ
                if (car.giay_to) {
                    if (car.giay_to.bang_lai_mat_truoc) {
                        document.getElementById('viewLicenseFront').src = car.giay_to.bang_lai_mat_truoc;
                    }
                    if (car.giay_to.bang_lai_mat_sau) {
                        document.getElementById('viewLicenseBack').src = car.giay_to.bang_lai_mat_sau;
                    }
                    if (car.giay_to.dang_ky_xe) {
                        document.getElementById('viewRegistration').src = car.giay_to.dang_ky_xe;
                    }
                }
                
                // Mở modal
                document.getElementById('viewCarModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('Lỗi khi tải chi tiết xe:', error);
                showToast('Đã xảy ra lỗi khi tải chi tiết xe', 'error');
            }
        }

        // Duyệt xe
        async function approveCar(carId) {
            try {
                const response = await fetch(`/api/cars/${carId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Duyệt xe thành công', 'success');
                    
                    // Cập nhật danh sách xe
                    const carIndex = pendingCars.findIndex(car => car.id.toString() === carId);
                    if (carIndex !== -1) {
                        const approvedCar = {...pendingCars[carIndex], tinh_trang: 'san_sang'};
                        cars.push(approvedCar);
                        pendingCars.splice(carIndex, 1);
                        
                        // Nếu đang xem modal chi tiết, đóng nó lại
                        if (document.getElementById('viewCarModal').classList.contains('active')) {
                            document.getElementById('viewCarModal').classList.remove('active');
                            document.body.style.overflow = '';
                        }
                        
                        // Cập nhật lại danh sách hiển thị
                        const activeFilter = document.querySelector('.filter-item.active').dataset.type;
                        renderCarList(activeFilter);
                    }
                } else {
                    showToast(data.message || 'Không thể duyệt xe', 'error');
                }
            } catch (error) {
                console.error('Lỗi khi duyệt xe:', error);
                showToast('Đã xảy ra lỗi khi duyệt xe', 'error');
            }
        }

        // Mở modal từ chối xe
        function openRejectModal(carId) {
            document.getElementById('rejectCarId').value = carId;
            document.getElementById('rejectCarModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Từ chối xe
        async function rejectCar(carId, reason) {
            try {
                const response = await fetch(`/api/cars/${carId}/reject`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Từ chối xe thành công', 'success');
                    
                    // Cập nhật danh sách xe
                    const carIndex = pendingCars.findIndex(car => car.id.toString() === carId);
                    if (carIndex !== -1) {
                        pendingCars.splice(carIndex, 1);
                        
                        // Đóng modal từ chối
                        document.getElementById('rejectCarModal').classList.remove('active');
                        
                        // Nếu đang xem modal chi tiết, đóng nó lại
                        if (document.getElementById('viewCarModal').classList.contains('active')) {
                            document.getElementById('viewCarModal').classList.remove('active');
                        }
                        
                        document.body.style.overflow = '';
                        
                        // Cập nhật lại danh sách hiển thị
                        const activeFilter = document.querySelector('.filter-item.active').dataset.type;
                        renderCarList(activeFilter);
                    }
                } else {
                    showToast(data.message || 'Không thể từ chối xe', 'error');
                }
            } catch (error) {
                console.error('Lỗi khi từ chối xe:', error);
                showToast('Đã xảy ra lỗi khi từ chối xe', 'error');
            }
        }

        // Xóa xe
        async function deleteCar(carId) {
            try {
                const response = await fetch(`/api/cars/${carId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Xóa xe thành công', 'success');
                    
                    // Cập nhật danh sách xe
                    const carIndex = cars.findIndex(car => car.id.toString() === carId);
                    if (carIndex !== -1) {
                        cars.splice(carIndex, 1);
                        
                        // Cập nhật lại danh sách hiển thị
                        const activeFilter = document.querySelector('.filter-item.active').dataset.type;
                        renderCarList(activeFilter);
                    }
                } else {
                    showToast(data.message || 'Không thể xóa xe', 'error');
                }
            } catch (error) {
                console.error('Lỗi khi xóa xe:', error);
                showToast('Đã xảy ra lỗi khi xóa xe', 'error');
            }
        }

        // Hiển thị thông báo toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <div class="message">${message}</div>
                </div>
                <i class="fas fa-times close"></i>
                <div class="progress"></div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('active');
            }, 10);
            
            const closeBtn = toast.querySelector('.close');
            closeBtn.addEventListener('click', () => {
                toast.classList.remove('active');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            });
            
            setTimeout(() => {
                toast.classList.remove('active');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // Xử lý sự kiện cho modal
        function setupModals() {
            // Modal xem chi tiết xe
            const viewCarModal = document.getElementById('viewCarModal');
            const viewCarCloseBtn = viewCarModal.querySelector('.btn-close');
            
            viewCarCloseBtn.addEventListener('click', () => {
                viewCarModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            // Nút duyệt xe trong modal chi tiết
            document.getElementById('approveCarBtn').addEventListener('click', () => {
                if (currentCarId) {
                    approveCar(currentCarId);
                }
            });
            
            // Nút mở modal từ chối trong modal chi tiết
            document.getElementById('openRejectModalBtn').addEventListener('click', () => {
                if (currentCarId) {
                    // Đóng modal chi tiết
                    viewCarModal.classList.remove('active');
                    
                    // Mở modal từ chối
                    openRejectModal(currentCarId);
                }
            });
            
            // Modal từ chối xe
            const rejectCarModal = document.getElementById('rejectCarModal');
            const rejectCarCloseBtn = rejectCarModal.querySelector('.btn-close');
            const rejectCarCancelBtn = rejectCarModal.querySelector('.btn-secondary');
            
            rejectCarCloseBtn.addEventListener('click', () => {
                rejectCarModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            rejectCarCancelBtn.addEventListener('click', () => {
                rejectCarModal.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            // Form từ chối xe
            document.getElementById('rejectCarForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const carId = document.getElementById('rejectCarId').value;
                const reason = e.target.querySelector('textarea').value;
                
                if (!reason) {
                    showToast('Vui lòng nhập lý do từ chối', 'error');
                    return;
                }
                
                // Thêm trạng thái loading
                const submitBtn = e.target.querySelector('[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                
                rejectCar(carId, reason);
            });
        }

        // Filter handling
        document.querySelectorAll('.filter-item').forEach(filter => {
            filter.addEventListener('click', () => {
                document.querySelector('.filter-item.active').classList.remove('active');
                filter.classList.add('active');
                renderCarList(filter.dataset.type);
            });
        });

        // Modal handling (chỉ cho modal thêm/sửa xe)
        const modal = document.getElementById('carModal');
        const addBtn = document.getElementById('addCarBtn');
        const closeBtn = document.querySelector('#carModal .btn-close');
        const cancelBtn = document.querySelector('#carModal .btn-secondary');

        function openModal() {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        addBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // Image preview handling
        const imagePreview = document.getElementById('imagePreview');
        const imageInput = document.getElementById('imageInput');

        imagePreview.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission
        document.getElementById('carForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // Add loading state
            const submitBtn = e.target.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            // Simulate API call
            setTimeout(() => {
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Đã lưu';
                setTimeout(() => {
                    closeModal();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Lưu';
                }, 1000);
            }, 1500);
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const activeFilter = document.querySelector('.filter-item.active').dataset.type;
            
            // Tìm kiếm dựa trên bộ lọc hiện tại
            const filteredCars = activeFilter === 'pending' ? pendingCars : cars;
            
            const searchResults = filteredCars.filter(car => {
                return car.ten_xe.toLowerCase().includes(searchTerm) || 
                       car.bien_so.toLowerCase().includes(searchTerm) ||
                       (car.chu_xe && car.chu_xe.ho_ten.toLowerCase().includes(searchTerm));
            });
            
            // Hiển thị kết quả tìm kiếm
            renderSearchResults(searchResults);
        });
        
        // Hiển thị kết quả tìm kiếm
        function renderSearchResults(results) {
            const tableBody = document.getElementById('carTableBody');
            tableBody.innerHTML = '';
            
            // Cập nhật số lượng xe hiển thị
            document.querySelector('.header1 h2 span').textContent = `(${results.length} xe)`;
            
            results.forEach((car, index) => {
                // Tương tự như trong hàm renderCarList
                const row = document.createElement('tr');
                
                const isPending = car.tinh_trang === 'cho_duyet';
                
                let actionButtons = '';
                if (isPending) {
                    actionButtons = `
                        <button class="btn-action btn-view" data-id="${car.id}" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-approve" data-id="${car.id}" title="Duyệt xe">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn-action btn-reject" data-id="${car.id}" title="Từ chối xe">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn-action btn-edit" data-id="${car.id}" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" data-id="${car.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><img src="${car.hinh_anh_chinh || '/public/image/lazy.svg'}" alt="${car.ten_xe}" class="car-img"></td>
                    <td><a href="#" class="car-name" data-id="${car.id}">${car.ten_xe}</a></td>
                    <td>${car.bien_so}</td>
                    <td class="car-price">${formatCurrency(car.gia_thue)}</td>
                    <td>${car.so_cho_ngoi} chỗ</td>
                    <td>${getStatusLabel(car.tinh_trang)}</td>
                    <td>${car.chu_xe?.ho_ten || 'N/A'}</td>
                    <td>
                        <div class="car-actions">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Gắn lại sự kiện
            attachEventListeners();
        }

        // Lấy danh sách xe khi trang tải xong
        document.addEventListener('DOMContentLoaded', () => {
            fetchCars();
            setupModals();
        });
    </script>
</body>
</html>
